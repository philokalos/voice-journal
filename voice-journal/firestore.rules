rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Entry collection rules
    match /entries/{entryId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.user_id;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.user_id;
    }
    
    // Audit logs - read-only for users, write-only for system
    match /entry_audit_logs/{auditId} {
      // Users can only read their own audit logs
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Only system (Cloud Functions) can write audit logs
      allow write: if false; // This prevents direct client writes
    }
    
    // Data deletion logs - admin only access
    match /data_deletion_logs/{logId} {
      // Only system (Cloud Functions) can read/write deletion logs
      allow read, write: if false; // This prevents direct client access
    }
    
    // User encryption keys - user can only access their own key
    match /user_encryption_keys/{userId} {
      // Users can only read/write their own encryption key
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Default deny rule
    match /{document=**} {
      allow read, write: if false;
    }
  }
}